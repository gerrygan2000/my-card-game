<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏äÊµ∑Âπ≤Áû™Áúº (Final Kill Edition)</title>
    <script src="https://cdn.staticfile.net/peerjs/1.5.2/peerjs.min.js"></script>
    <script src="https://cdn.staticfile.net/vConsole/3.15.1/vconsole.min.js"></script>
    <script>
        var vConsole = new VConsole({
            onReady: function() {
                // [Fix] Âº∫Âà∂Â∞ÜÊåâÈíÆÁßªÂà∞Â±èÂπïÊ≠£‰∏≠Èó¥
                var btn = document.querySelector('.vc-switch');
                if(btn) {
                    btn.style.top = '50%';
                    btn.style.left = '50%';
                    btn.style.transform = 'translate(-50%, -50%)';
                    btn.style.right = 'auto';
                    btn.style.bottom = 'auto';
                }
            }
        });
    </script>
    <style>
        /* ==================== 1. THEME & VARIABLES ==================== */
        :root {
            --bg-deep-wood: #1a1a1a;
            --table-overlay: rgba(0, 0, 0, 0.4);
            --neon-cyan: #00fff2;
            --neon-pink: #ff00de;
            --vintage-gold: #d4af37;
            --paper-yellow: #fdfbf7;
            --card-width: 64px;
            --card-height: 96px;
            --card-radius: 6px;
            --shadow-card: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* ==================== 2. GLOBAL LAYOUT ==================== */
        body {
            font-family: 'Songti SC', 'SimSun', serif; 
            margin: 0; overflow: hidden; height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
            color: #e0e0e0; background-color: var(--bg-deep-wood);
        }

        #game-table-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1533090161767-e6ffed986c88?q=80&w=2069');
            background-size: cover; background-position: center; z-index: -2;
        }
        #game-table-bg::before { content: ""; position: absolute; inset: 0; background: var(--table-overlay); }

        .scene { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .scene.active { display: flex; }

        /* ==================== 3. UI COMPONENTS ==================== */
        #start-screen { background: rgba(0,0,0,0.85); z-index: 500; }
        .title-logo {
            font-size: 56px; color: #fff;
            text-shadow: 0 0 10px #fff, 0 0 20px var(--neon-cyan), 0 0 40px var(--neon-pink);
            border: 4px solid #fff; padding: 10px 30px; border-radius: 10px; margin-bottom: 30px;
            box-shadow: 0 0 20px var(--neon-cyan), inset 0 0 20px var(--neon-cyan);
            background: rgba(0,0,0,0.6);
        }
        .menu-panel {
            background: rgba(46, 23, 15, 0.95); padding: 30px; width: 320px;
            border: 2px solid var(--vintage-gold); box-shadow: 0 0 30px rgba(0,0,0,0.8);
            text-align: center; display: flex; flex-direction: column; gap: 15px;
        }
        .styled-input {
            background: rgba(0,0,0,0.3); border: 1px solid #8d6e63; color: #fff;
            padding: 8px; width: 100%; box-sizing: border-box; text-align: center;
            font-size: 16px; margin-top: 5px; font-family: monospace;
        }

        .main-btn {
            padding: 12px 0; font-size: 20px; background: var(--vintage-gold);
            border: 2px solid #fff; color: #2e1e19; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px var(--vintage-gold); width: 100%;
        }
        .main-btn.secondary { background: #2e1e19; border: 2px solid #8d6e63; color: #d7ccc8; box-shadow: none; font-size: 16px; }
        .game-btn { padding: 12px 24px; border-radius: 4px; font-weight: bold; font-size: 18px; border: 1px solid #ccc; border-bottom: 4px solid #999; cursor: pointer; }
        .btn-green { background: #4caf50; color: #fff; border-color: #1b5e20; }
        .btn-green:disabled { background: #555; cursor: not-allowed; }
        .btn-gray { background: #f5f5f5; color: #333; }
        .quit-btn { position: absolute; top: 15px; left: 15px; background: #2e1e19; border: 1px solid #5d4037; color: #ccc; padding: 6px 16px; z-index: 500; cursor: pointer; }

        #top-room-info { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 22px; color: var(--vintage-gold); z-index: 100; font-weight: bold; text-shadow: 0 0 10px #000, 0 0 20px var(--vintage-gold); }
        #marquee-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 28px; background: rgba(0,0,0,0.6); overflow: hidden; z-index: 200; border-top: 1px solid #333; display: flex; align-items: center; }
        #marquee-content { white-space: nowrap; color: var(--neon-cyan); font-size: 14px; font-family: monospace; animation: marqueeScroll 25s linear infinite; }
        @keyframes marqueeScroll { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        #turn-notification {
            position: absolute; top: 22%; left: 50%; transform: translate(-50%, -50%);
            font-size: 32px; font-weight: bold; color: #fff;
            text-shadow: 0 0 10px #000, 0 0 20px var(--vintage-gold);
            background: rgba(0,0,0,0.7); padding: 12px 35px; border-radius: 8px;
            border: 2px solid var(--vintage-gold); pointer-events: none; opacity: 0; z-index: 300;
            transition: opacity 0.3s; white-space: nowrap;
        }
        #turn-notification.show { opacity: 1; }

        .card { width: var(--card-width); height: var(--card-height); background: #fdfbf7; border-radius: var(--card-radius); box-shadow: var(--shadow-card); position: relative; border: 1px solid #c0b090; overflow: hidden; }
        .card.red { color: #b71c1c; } .card.black { color: #212121; }
        .card-inner { width: 100%; height: 100%; display: grid; grid-template-columns: 18px 1fr 18px; padding: 3px; box-sizing: border-box; }
        .corner { display: flex; flex-direction: column; align-items: center; font-size: 16px; line-height: 0.9; font-weight: bold; }
        .corner.bottom { transform: rotate(180deg); align-self: end; }
        .center-suit { display: flex; justify-content: center; align-items: center; font-size: 40px; opacity: 0.9; }
        
        .my-card { margin-left: -20px; cursor: pointer; transition: transform 0.2s, z-index 0.2s; box-shadow: -2px 0 6px rgba(0,0,0,0.3); transform-origin: bottom center; }
        .my-card:first-child { margin-left: 0; }
        /* „ÄêÂº∫Âà∂ÈÄªËæë„ÄëÔºöÊú™ÈÄâÁâåÂú®Ââç(È´òz)ÔºåÁÇπ‰∫ÆÁâåÂú®Âêé(‰Ωéz) */
        .my-card.selected { transform: translateY(-25px); border: 2px solid var(--vintage-gold); box-shadow: 0 0 15px var(--vintage-gold); background: #fff; z-index: 1 !important; }
        .desk-card { position: absolute; box-shadow: 1px 1px 5px rgba(0,0,0,0.4); }
        .flying-card { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }

        #players-container { position: absolute; inset: 0; pointer-events: none; z-index: 50; }
        .player-slot { position: absolute; width: 90px; display: flex; flex-direction: column; align-items: center; transition: all 0.5s; }
        .avatar { width: 54px; height: 54px; border-radius: 50%; background: #4e342e; border: 4px solid #3e2723; display: flex; justify-content: center; align-items: center; color: #d7ccc8; font-size: 24px; box-shadow: 0 5px 10px rgba(0,0,0,0.6); transition: transform 0.3s; position: relative; }
        .active-turn .avatar { border-color: var(--vintage-gold); box-shadow: 0 0 15px var(--vintage-gold); transform: scale(1.1); animation: avatarPulse 2s infinite; }
        @keyframes avatarPulse { 0% { box-shadow: 0 0 5px var(--vintage-gold); } 50% { box-shadow: 0 0 25px var(--vintage-gold); } 100% { box-shadow: 0 0 5px var(--vintage-gold); } }

        .card-count-badge { position: absolute; top: 0; left: -5px; background: #b71c1c; color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid #fff; z-index: 10; }
        .player-name-tag { background: rgba(0,0,0,0.7); color: #ddd; font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-top: -8px; z-index: 10; border: 1px solid #555; white-space: nowrap; }
        .action-bubble { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 80; white-space: nowrap; border: 2px solid #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); pointer-events: none; }
        .action-bubble.show { opacity: 1; top: -50px; }

        .played-cards-slot { position: absolute; width: 100px; height: 90px; display: flex; justify-content: center; align-items: center; z-index: 20; }
        .slot-bottom { bottom: 20px; left: 20px; } .slot-bottom .played-cards-slot { bottom: 120px; left: 50%; transform: translateX(-50%); }
        .slot-right { top: 45%; right: 15px; transform: translateY(-50%); } .slot-right .played-cards-slot { right: 90px; top: 50%; transform: translateY(-50%); }
        .slot-left { top: 45%; left: 15px; transform: translateY(-50%); } .slot-left .played-cards-slot { left: 90px; top: 50%; transform: translateY(-50%); }
        .slot-top { top: 15px; left: 50%; transform: translateX(-50%); } .slot-top .played-cards-slot { top: 80px; left: 50%; transform: translateX(-50%); }
        .slot-top-left { top: 15px; left: 20%; } .slot-top-left .played-cards-slot { top: 70px; left: 50%; transform: translateX(-50%); }
        .slot-top-right { top: 15px; right: 20%; } .slot-top-right .played-cards-slot { top: 70px; left: 50%; transform: translateX(-50%); }

        /* „ÄêÂº∫Âà∂ÂõæÂ±ÇÁΩÆÂ∫ï„Äë */
        #center-table { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 160px; z-index: -1; background: radial-gradient(#1e8449, #145a32); border: 8px solid #2e1e19; border-radius: 80px; box-shadow: inset 0 0 20px #000; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        #deck-pile { width: var(--card-width); height: var(--card-height); border-radius: var(--card-radius); background: repeating-linear-gradient(45deg, #283593 0px, #283593 5px, #fff 5px, #fff 6px); border: 3px solid #fff; display: flex; justify-content: center; align-items: center; box-shadow: -3px 3px 6px rgba(0,0,0,0.6); }
        #my-hand { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; height: 110px; width: auto; max-width: 90%; z-index: 100; }
        #player-controls { position: absolute; bottom: 45px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 150; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        #player-controls.active { opacity: 1; pointer-events: auto; }
        
        #settlement-modal { background: rgba(0,0,0,0.9); z-index: 1000; }
        .modal-content { background: #fdfbf7; color: #333; width: 90%; max-width: 450px; border: 8px solid #5d4037; border-radius: 2px; box-shadow: 0 0 50px #000; overflow: hidden; }
        .choice-btn { width: 50px; height: 50px; border: 2px solid #555; background: #222; color: #aaa; font-size: 20px; cursor: pointer; margin: 0 5px; border-radius: 4px; }
        .choice-btn.selected { background: var(--vintage-gold); color: #000; border-color: #fff; font-weight: bold; }

        @media (max-width: 500px) {
            :root { --card-width: 50px; --card-height: 75px; }
            #my-hand { height: 90px; } .title-logo { font-size: 32px; padding: 5px 15px; }
        }
    </style>
</head>
<body>

    <div id="game-table-bg"></div>

    <div id="start-screen" class="scene active">
        <div class="title-logo">‰∏äÊµ∑Âπ≤Áû™Áúº</div>
        <div class="menu-panel">
            <div class="input-group" style="text-align:left;">
                <label style="color:#aaa; font-size:14px;">‰Ω†ÁöÑÊòµÁß∞</label>
                <input type="text" id="nickname-input" class="styled-input" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÂ§ßÂêç" maxlength="8" required>
            </div>
            <button class="main-btn" id="start-ai-btn" onclick="UI.showCountPicker()">ÂçïÊú∫ÁªÉ‰π†</button>
            <div style="margin: 10px 0; border-top: 1px solid #555; padding-top: 15px;">
                <div style="font-size:14px; color:#aaa; margin-bottom:10px;">ÁΩëÁªúÂØπÊàò</div>
                <button class="main-btn secondary" onclick="UI.showLobby('host')">ÂàõÂª∫ÊàøÈó¥</button>
                <button class="main-btn secondary" onclick="UI.showLobby('join')">Âä†ÂÖ•ÊàøÈó¥</button>
            </div>
            <button id="cassette-btn" style="margin-top: 15px; padding: 8px 20px; background: #2e1e19; border: 2px solid #8d6e63; color: #d7ccc8; cursor: pointer; border-radius: 4px; font-family: monospace; width: 100%;" onclick="AUDIO.Recorder.openUI()">üéôÔ∏è Á£ÅÂ∏¶ÂΩïÈü≥ÂÆ§</button>
            <div style="font-size: 12px; color: #8d6e63; margin-top: 10px; opacity: 0.6;">Powered by Á£äÂ≠ê</div>
        </div>
    </div>

    <div id="count-picker" class="scene" style="background: rgba(0,0,0,0.85); z-index: 600;">
        <div class="menu-panel">
            <div style="font-size: 22px; color: #fff; margin-bottom: 10px;">ËØ∑ÈÄâÊã©ÂØπÊàò‰∫∫Êï∞</div>
            <div style="display:flex; justify-content:center; gap: 10px; margin-bottom: 25px;">
                <button class="choice-btn" onclick="APP.startLocal(3)">3</button>
                <button class="choice-btn" onclick="APP.startLocal(4)">4</button>
                <button class="choice-btn" onclick="APP.startLocal(5)">5</button>
                <button class="choice-btn" onclick="APP.startLocal(6)">6</button>
            </div>
            <button class="main-btn secondary" onclick="document.getElementById('count-picker').classList.remove('active')">ËøîÂõû</button>
        </div>
    </div>

    <div id="lobby-screen" class="scene">
        <div class="menu-panel" style="width: 400px;">
            <div id="lobby-title" style="font-size: 24px; color: #fff; margin-bottom: 10px;">ÂáÜÂ§áÊàøÈó¥</div>
            <div id="host-ui" style="display:none;">
                <div style="color:#aaa; font-size:14px;">ÊàøÈó¥ PIN Á†Å</div>
                <div class="pin-display" id="my-pin" style="font-size:48px; font-family:monospace; color:var(--neon-cyan); letter-spacing:5px;">....</div>
                <div class="lobby-list" id="host-player-list" style="margin:10px 0; background:#222; padding:10px; height:100px; overflow-y:auto; text-align:left;">Á≠âÂæÖËøûÊé•...</div>
                <div style="font-size:16px; color:#aaa; margin-bottom:10px;">ÊÄª‰∫∫Êï∞</div>
                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                    <button class="choice-btn selected" onclick="UI.selectPlayerCount(3, this)">3</button>
                    <button class="choice-btn" onclick="UI.selectPlayerCount(4, this)">4</button>
                    <button class="choice-btn" onclick="UI.selectPlayerCount(5, this)">5</button>
                    <button class="choice-btn" onclick="UI.selectPlayerCount(6, this)">6</button>
                </div>
                <button class="main-btn" onclick="APP.launchNetworkGame()">ÂºÄÂßãÊ∏∏Êàè</button>
            </div>
            <div id="client-ui" style="display:none;">
                <input type="tel" id="join-pin" placeholder="PIN" maxlength="4" style="background:#333; color:#fff; border:2px solid #555; font-size:24px; padding:10px; width:150px; text-align:center; margin-bottom:20px; letter-spacing:5px;">
                <br>
                <button class="main-btn" onclick="APP.joinGame()">Á´ãÂç≥ËøûÊé•</button>
                <div id="join-status" style="margin-top:10px; color:#ccc;"></div>
            </div>
            <button class="quit-btn" style="position:relative; top:auto; left:auto; margin-top:10px;" onclick="location.reload()">ÈÄÄÂá∫</button>
        </div>
    </div>

    <div id="game-scene" class="scene">
        <div id="top-room-info"></div>
        <div id="turn-notification">ËΩÆÂà∞‰Ω†‰∫Ü</div>
        <div id="game-ui" style="width:100%; height:100%;">
            <button class="quit-btn" onclick="APP.quit()">ÈÄÄÂá∫Ê∏∏Êàè</button>
            <div class="net-status" id="net-indicator" style="display:none; position:absolute; top:15px; right:15px; color:var(--neon-cyan);">‚óè ONLINE</div>
            <div id="players-container"></div>
            <div id="center-table"><div id="deck-pile"><span id="deck-count" style="color:#fff; font-weight:bold; font-size:20px;">54</span></div></div>
            <div id="player-controls">
                <button class="game-btn btn-gray" id="btn-pass" onclick="APP.humanPass()">‰∏çË¶Å</button>
                <button class="game-btn btn-green" id="btn-play" onclick="APP.humanPlay()" disabled>Âá∫Áâå</button>
            </div>
        </div>
        <div id="marquee-bar"><div id="marquee-content"></div></div>
    </div>

    <div id="settlement-modal" class="scene">
        <div class="modal-content">
            <div style="background: #8d6e63; color: #fff; padding: 20px; text-align: center; font-size: 24px; font-weight: bold;">Êú¨Â±ÄÁªìÁÆó</div>
            <div id="settle-list" style="padding: 10px;"></div>
            <div style="padding: 20px; text-align: center;">
                <button class="main-btn" id="next-round-btn" onclick="APP.nextRound()">‰∏ã‰∏ÄÂ±Ä</button>
                <div id="wait-host-msg" style="display:none; color:#666; margin-top: 10px;">Á≠âÂæÖÊàø‰∏ªÂèëÁâå...</div>
            </div>
        </div>
    </div>

    <div id="cassette-modal" class="scene">
        <div class="cassette-panel">
            <div id="tape-list"></div>
            <div style="text-align:center; margin-top:20px;"><button class="main-btn" style="font-size:16px;" onclick="AUDIO.Recorder.closeUI()">Save & Close</button></div>
        </div>
    </div>

<script>
    /* ==========================================================================
       1. CONFIGURATION (LOCKED CORE)
       ========================================================================== */
    const CONFIG = {
        SUITS: ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'], RANKS: ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'],
        VALS: { '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14, '2':15, 'S':16, 'B':17 },
        NPC_NAMES: ["Âº†Ê†ºÈáå", "ÂõõÁúº", "ËÄÅÁî≤È±º", "Ë∑∑ËÑö", "ËÄÅÁà∑Âèî", "ÁÖ§È•º", "ÈòøËÉ°‰π±", "ÈòøÁº∫Ë•ø", "ÁâôËÉ°Ëõã", "ÁõéÂ§¥"],
        SHANGHAI_WORDS: {
            play: ["ÂçñÁõ∏ËõÆÂ•ΩÔºÅ", "ÊéºÁÖû‰æ¨ÔºÅ", "Ëµ∞‰∏ÄÂº†„ÄÇ"],
            pass: ["ÂØªÂØªÁúã„ÄÇ", "ÊòÇ‰∏â...", "‰ºêË¶Å„ÄÇ"],
            draw: ["Á¢∞Á¢∞ËøêÊ∞î„ÄÇ", "ÁúãÂº†Â•ΩÁâå„ÄÇ"],
            win: ["Ëæ£ÊâãÂêßÔºåÊ∏ÖÁàΩÔºÅ", "ÁâõÈÄºÔºÅ", "ËÄÅ‰π±ÔºÅ"],
            lose: ["‰ºêÊù•ËµõÔºåÁªüÁªüÂêÉËÑ±ÔºÅ", "ÂÜåÈÇ£ÔºÅ"]
        },
        LAYOUTS: { 3: ['slot-bottom', 'slot-right', 'slot-left'], 4: ['slot-bottom', 'slot-right', 'slot-top', 'slot-left'], 5: ['slot-bottom', 'slot-right', 'slot-top-right', 'slot-top-left', 'slot-left'], 6: ['slot-bottom', 'slot-right', 'slot-top-right', 'slot-top', 'slot-top-left', 'slot-left'] },
        PEER_CONFIG: { 
            host: '0.peerjs.com', port: 443, secure: true, 
            debug: 3, // [Debug] ÂºÄÂêØÊúÄÈ´òÁ∫ßÂà´Êó•ÂøóÔºåÊçïÊçâÊâÄÊúâÊè°ÊâãÁªÜËäÇ
            pingInterval: 5000,
            config: { 
                iceServers: [ 
                    // 1. ÂõΩÂÜÖ STUN (Áî®‰∫éÂ∞ùËØïÁõ¥Ëøû)
                    { urls: "stun:stun.qq.com:3478" },
                    
                    // 2. ÂÖ≥ÈîÆ‰øÆÊîπÔºöÂº∫Âà∂‰ΩøÁî® TCP ÂçèËÆÆÁöÑ TURN ÊúçÂä°Âô® (Áî®‰∫éÁ©øÈÄèÁîµ‰ø°/ÁßªÂä®Èò≤ÁÅ´Â¢ô)
                    // Ê≥®ÊÑèÔºöËøôÈáåÊòæÂºèÊ∑ªÂä†‰∫Ü ?transport=tcp ÂèÇÊï∞
                    { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "e4b469df87f075fa140a04a8", credential: "V141Y4bT8Fgomte0" },
                    { urls: "turn:openrelay.metered.ca:80?transport=tcp", username: "e4b469df87f075fa140a04a8", credential: "V141Y4bT8Fgomte0" }
                ],
                // 3. Âº∫Âà∂ËØ∑Ê±ÇÂÖºÂÆπÊ®°Âºè
                sdpSemantics: 'unified-plan' 
            } 
        },
        APP_PREFIX: 'gandengyan-fin-'
    };

    /* ==========================================================================
       2. STATE & RULES
       ========================================================================== */
    const STATE = { players: [], deck: [], currTurn: 0, lastPlay: null, passCount: 0, playerCount: 3, selectedIndices: [], bombCount: 0 };

    const RULES = {
        analyze: function(c) {
            if(!c||!c.length)return null; c.sort((a,b)=>a.val-b.val); let len=c.length, j=c.filter(x=>x.isJoker).length, n=c.filter(x=>!x.isJoker);
            if(len===1&&c[0].isJoker) return null; if(len===2&&j===2) return {type:'rocket',val:99,count:2};
            if(len===1) return {type:'single',val:c[0].val,count:1};
            if(len===2) { if(j===0&&c[0].val===c[1].val) return {type:'pair',val:c[0].val,count:2}; if(j===1) return {type:'pair',val:n[0].val,count:2}; }
            if(len>=3&&n.every(x=>x.val===n[0].val)) return {type:'bomb',val:n[0].val,count:len};
            if(!c.some(x=>x.val===15)) {
                let s=new Set(); n.forEach(x=>s.add(x.val));
                if(s.size===n.length && (n[n.length-1].val-n[0].val+1)-n.length<=j) return {type:'straight',val:n[0].val,count:len};
            }
            return null;
        },
        canBeat: function(my, table) {
            if(!my)return false; if(!table)return true; if(my.type==='rocket')return true; if(table.type==='rocket')return false;
            if(my.type==='bomb') { if(table.type!=='bomb')return true; return my.count>table.count || (my.count===table.count && my.val>table.val); }
            if(table.type==='bomb')return false;
            if(my.type===table.type && my.count===table.count) {
                if((my.type==='single'||my.type==='pair') && my.val===15) return true;
                return my.val===table.val+1;
            } return false;
        }
    };

    const AI = {
        move: function(player) {
            let hand=[...player.hand], last=STATE.lastPlay, move=null, groups=APP.groupHand(hand);
            if(!last) { move = groups.pairs.find(p=>p.val<15) || groups.pairs[0] || groups.singles.find(s=>s.val<15) || groups.singles[0] || groups.bombs[0]; }
            else {
                let pool = {'pair':groups.pairs,'single':groups.singles}[last.type] || [];
                let cands = [...pool.filter(m=>RULES.canBeat(m,last)), ...groups.bombs, ...groups.rockets];
                if(cands.length) {
                    cands.sort((a,b)=>(a.val+(a.type.includes('bomb')?100:0)) - (b.val+(b.type.includes('bomb')?100:0)));
                    move=cands[0];
                }
            }
            if(move) { let idxs=move.idxs; idxs.sort((a,b)=>b-a).forEach(i=>player.hand.splice(i,1)); APP.turnEnd('play', idxs.map(i=>hand[i])); } else APP.turnEnd('pass');
        }
    };

    /* ==========================================================================
       3. UI ENGINE (INCREMENTAL RENDERING)
       ========================================================================== */
    const UI = {
        showCountPicker: function() {
            let nick = document.getElementById('nickname-input').value;
            if(!nick) { UI.showBubble(0, "‰æ¨Âè´ÊííÂêçÂ≠óÂï¶ÔºüËØ∑ËæìÂÖ•Â§ßÂêçÔºÅ"); return; }
            document.getElementById('count-picker').classList.add('active');
        },
        selectPlayerCount: function(n, btn) { document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); STATE.playerCount = n; },
        showLobby: function(mode) {
            let nick = document.getElementById('nickname-input').value;
            if(!nick) { UI.showBubble(0, "ËØ∑ËæìÂÖ•ÊòµÁß∞ÔºÅ"); return; }
            document.getElementById('start-screen').classList.remove('active'); document.getElementById('lobby-screen').classList.add('active');
            if(mode==='host') { document.getElementById('host-ui').style.display='block'; document.getElementById('client-ui').style.display='none'; APP.startHosting(); }
            else { document.getElementById('host-ui').style.display='none'; document.getElementById('client-ui').style.display='block'; }
        },
        updateLobbyList: function() { 
            let myName = document.getElementById('nickname-input').value || "Êàø‰∏ª";
            if(NET.mode==='host') document.getElementById('host-player-list').innerHTML = `<div class="lobby-item">1. ${myName}</div>` + NET.clients.map((c,i)=>`<div class="lobby-item">${i+2}. ${c.name}</div>`).join(''); 
        },
        renderLayout: function() {
            let container = document.getElementById('players-container'); 
            // Âè™ÊúâÂú®Â∏ÉÂ±Ä‰∏çÂ≠òÂú®Êó∂ÊâçÈáçÁªòÊ°ÜÊû∂ÔºåÈò≤Ê≠¢ÂêûÊéâÊ°åÈù¢‰∏äÁöÑÁâå
            if(!container.querySelector('.player-slot')) {
                container.innerHTML = '';
                let config = CONFIG.LAYOUTS[STATE.playerCount], myIdx = APP.myPlayerIdx;
                STATE.players.forEach((p, i) => {
                    let posClass = config[(i - myIdx + STATE.playerCount) % STATE.playerCount];
                    container.innerHTML += `<div class="player-slot ${posClass}" id="p-slot-${i}"><div class="action-bubble" id="bubble-${i}"></div><div class="avatar-wrapper"><div class="card-count-badge" id="badge-count-${i}">${p.hand.length}</div><div class="avatar" id="avatar-${i}">${i===myIdx?'Êàë':(p.isCpu?'ü§ñ':'üë§')}</div></div><div class="player-name-tag">${p.name}</div><div class="played-cards-slot" id="played-cards-${i}"></div></div>`;
                });
            }
            // Ê†πÊçÆSTATEÊÅ¢Â§çÊâÄÊúâÁé©ÂÆ∂ÁöÑÂá∫ÁâåÊòæÁ§∫
            STATE.players.forEach((p, i) => this.renderPlayedCards(i, p.lastCards || []));
            if(!document.getElementById('my-hand')) {
                let hand = document.createElement('div'); hand.id = 'my-hand';
                document.getElementById('game-ui').appendChild(hand);
            }
        },
        renderHand: function() {
            let container = document.getElementById('my-hand'); container.innerHTML = '';
            if(!STATE.players[APP.myPlayerIdx]) return;
            STATE.players[APP.myPlayerIdx].hand.forEach((card, idx) => {
                let el = document.createElement('div'); 
                let isSelected = STATE.selectedIndices.includes(idx);
                el.className = `card ${card.color} my-card ${isSelected?'selected':''}`;
                el.style.zIndex = isSelected ? 1 : 100 + idx; 
                let r=card.rank, s=card.suit; if(card.isJoker) r='JOKER';
                el.innerHTML = `<div class="card-inner"><div class="corner"><span>${r}</span><span class="suit">${s}</span></div><div class="center-suit">${s}</div><div class="corner bottom"><span>${r}</span></div></div>`;
                el.onclick = () => { let p=STATE.selectedIndices.indexOf(idx); if(p>=0)STATE.selectedIndices.splice(p,1); else STATE.selectedIndices.push(idx); UI.renderHand(); APP.checkHumanButtons(); };
                container.appendChild(el);
            });
        },
        // „ÄêÊâãÊúØÊàêÂäü„ÄëÔºöÊ≠§ÂáΩÊï∞Áé∞Âú®‰ªÖÊõ¥Êñ∞Â±ÄÈÉ®Âá∫Áâå‰ΩçÔºå‰∏•Á¶ÅÂÖ®Â±ÄÈáçÁΩÆÔºÅ
        renderPlayedCards: function(pIdx, cards) {
            let slot = document.getElementById(`played-cards-${pIdx}`); 
            if(!slot) return;
            // Â¶ÇÊûú cards ‰∏∫Á©∫ÔºåËØ¥ÊòéËØ•Áé©ÂÆ∂Âú®Ëøô‰∏ÄËΩÆËøòÊ≤°Âá∫ÁâåÊàñËÄÖÂàöË¢´Ê∏ÖÁêÜ„ÄÇ‰∏çË¶ÅÂπ≤Êâ∞ÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑ DOM„ÄÇ
            if(cards.length === 0) { slot.innerHTML = ''; return; }
            
            slot.innerHTML = ''; // ‰ªÖÊ∏ÖÁ©∫ÂΩìÂâçÂá∫Áâå‰∫∫ÁöÑÊßΩ‰Ωç
            cards.forEach((c, i) => {
                let el = document.createElement('div'); el.className = `card ${c.color} desk-card`;
                let r=c.rank, s=c.suit; if(c.isJoker) r='JOKER';
                el.innerHTML = `<div class="card-inner"><div class="corner"><span>${r}</span></div><div class="center-suit">${s}</div><div class="corner bottom"><span>${r}</span></div></div>`;
                el.style.transform = `rotate(${(i-cards.length/2)*5}deg) translateX(${i*15}px) scale(0.9)`; slot.appendChild(el);
            }); 
        },
        showBubble: function(pIdx, text) { let b = document.getElementById(`bubble-${pIdx}`); if(b) { b.innerText = text; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 1500); } },
        showTurnNotify: function(pIdx) {
            if(!STATE.players[pIdx]) return;
            let el = document.getElementById('turn-notification'); 
            el.innerText = (pIdx === APP.myPlayerIdx || (NET.mode === 'client' && STATE.players[pIdx].peerId === NET.peer.id)) ? "ËΩÆÂà∞‰Ω†‰∫Ü" : `ËΩÆÂà∞ ${STATE.players[pIdx].name} ‰∫Ü`;
            el.classList.add('show'); 
            document.querySelectorAll('.player-slot').forEach(e => e.classList.remove('active-turn')); 
            let active = document.getElementById(`p-slot-${pIdx}`); if(active) active.classList.add('active-turn');
        },
        updateInfo: function() {
            document.getElementById('deck-count').innerText = STATE.deck.length;
            STATE.players.forEach((p, i) => { let b = document.getElementById(`badge-count-${i}`); if(b) b.innerText = p.hand.length; });
            document.getElementById('marquee-content').innerText = "„ÄêÁ£äÂ≠êÂåÖÊàøÂÆûÊàòÊä•„Äë" + STATE.players.map(p => `${p.name}: ${p.chips}ÂÖÉ`).join(' | ');
        },
        animThrow: function(pIdx, cards, cb) {
            let start = (pIdx === APP.myPlayerIdx) ? document.getElementById('my-hand') : document.getElementById(`p-slot-${pIdx}`), end = document.getElementById(`played-cards-${pIdx}`);
            if(!start||!end) { if(cb)cb(); return; }
            let sR=start.getBoundingClientRect(), eR=end.getBoundingClientRect(), fly=document.createElement('div');
            fly.className='flying-card'; fly.style.left=(sR.left+sR.width/2)+'px'; fly.style.top=(sR.top+sR.height/2)+'px';
            cards.forEach((c,i)=>{ let el=document.createElement('div'); el.className=`card ${c.color}`; el.style.position='absolute'; el.style.left=(i*15)+'px'; fly.appendChild(el); });
            document.body.appendChild(fly);
            requestAnimationFrame(()=>{ fly.style.left=(eR.left+eR.width/2)+'px'; fly.style.top=(eR.top+eR.height/2)+'px'; fly.style.transform='scale(0.9)'; });
            setTimeout(()=>{ fly.remove(); if(cb)cb(); }, 500);
        },
        animSweep: function(cb) {
            let cards=document.querySelectorAll('.played-cards-slot .desk-card'); if(!cards.length){if(cb)cb();return;}
            let cx=window.innerWidth/2, cy=window.innerHeight/2;
            cards.forEach(c=>{ let r=c.getBoundingClientRect(); c.style.position='fixed'; c.style.left=r.left+'px'; c.style.top=r.top+'px'; c.style.transition='all 0.6s ease-in'; requestAnimationFrame(()=>{c.style.left=cx+'px'; c.style.top=cy+'px'; c.style.opacity=0;}); });
            // „ÄêÊ∏ÖÁêÜÊåá‰ª§ÂîØ‰∏ÄÂåñ„ÄëÔºöÂú®Ê≠§Â§ÑÊ∏ÖÁ©∫ STATE Êï∞ÊçÆ
            STATE.players.forEach(p => p.lastCards = []);
            setTimeout(()=>{document.querySelectorAll('.played-cards-slot').forEach(e=>e.innerHTML='');if(cb)cb();},650);
        }
    };

    /* ==========================================================================
       4. APP LOGIC
       ========================================================================== */
    const APP = {
        myPlayerIdx: 0,
        startLocal: function(count) { 
            NET.mode = 'offline'; this.myPlayerIdx = 0; STATE.playerCount = count;
            document.getElementById('count-picker').classList.remove('active');
            this.launchGame(count); 
        },
        startHosting: function() { NET.initHost((pin) => { document.getElementById('my-pin').innerText = pin; }); },
        joinGame: function() {
            let pin = document.getElementById('join-pin').value; if(pin.length!==4) return;
            let name = document.getElementById('nickname-input').value;
            if(!name) { alert("ËØ∑ËæìÂÖ•ÊòµÁß∞ÔºÅ"); return; }
            document.getElementById('join-status').innerText = "ËøûÊé•‰∏≠...";
            NET.joinRoom(pin, name, () => { document.getElementById('join-status').innerText = "ËøõÂÖ•ÂåÖÊàø!"; }, () => document.getElementById('join-status').innerText = "ËøûÊé•Â§±Ë¥•");
        },
        launchNetworkGame: function() {
            if(NET.mode !== 'host') return;
            let myName = document.getElementById('nickname-input').value || "Êàø‰∏ª";
            let players = [{id:0,name:myName,isCpu:false,hand:[],chips:200, peerId: NET.peer.id, lastCards:[]}];
            NET.clients.forEach((c,i) => players.push({id:i+1,name:c.name,isCpu:false,hand:[],chips:200,peerId:c.id, lastCards:[]}));
            for(let i=1+NET.clients.length; i<STATE.playerCount; i++) players.push({id:i,name:CONFIG.NPC_NAMES[i-1],isCpu:true,hand:[],chips:200, lastCards:[]});
            STATE.players = players; 
            NET.broadcast({ type: 'GAME_START', players: players, playerCount: STATE.playerCount, pin: NET.myPin }); 
            this.start();
        },
        start: function() {
            AUDIO.init(); 
            document.getElementById('start-screen').classList.remove('active'); 
            document.getElementById('lobby-screen').classList.remove('active'); 
            document.getElementById('game-scene').classList.add('active');
            if(NET.mode !== 'offline') document.getElementById('net-indicator').style.display = 'block';
            if(NET.mode === 'client') UI.renderLayout(); else this.resetRound();
        },
        launchGame: function(count) {
            STATE.players=[]; let names=[...CONFIG.NPC_NAMES].sort(()=>Math.random()-0.5);
            let myName = document.getElementById('nickname-input').value || "Êàë";
            for(let i=0; i<count; i++) STATE.players.push({id:i,name:i===0?myName:names[i-1],isCpu:i!==0,hand:[],chips:200, lastCards:[]});
            this.start();
        },
        resetRound: function() {
            STATE.lastPlay=null; STATE.passCount=0; STATE.selectedIndices=[]; STATE.bombCount=0;
            document.getElementById('settlement-modal').classList.remove('active');
            STATE.players.forEach(p => p.lastCards = []);
            document.querySelectorAll('.played-cards-slot').forEach(e=>e.innerHTML='');
            STATE.deck=[]; CONFIG.RANKS.forEach(r=>CONFIG.SUITS.forEach(s=>STATE.deck.push({suit:s,rank:r,val:CONFIG.VALS[r],color:['‚ô•','‚ô¶'].includes(s)?'red':'black',isJoker:false})));
            STATE.deck.push({suit:'ü§°',rank:'J',val:16,color:'black',isJoker:true},{suit:'üë∫',rank:'J',val:17,color:'red',isJoker:true});
            for(let i=STATE.deck.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[STATE.deck[i],STATE.deck[j]]=[STATE.deck[j],STATE.deck[i]];}
            STATE.players.forEach(p=>p.hand=[]); for(let i=0;i<5;i++)STATE.players.forEach(p=>{if(STATE.deck.length)p.hand.push(STATE.deck.pop())});
            STATE.players.forEach(p=>p.hand.sort((a,b)=>a.val-b.val));
            STATE.currTurn = Math.floor(Math.random()*STATE.playerCount);
            if(STATE.deck.length > 0) STATE.players[STATE.currTurn].hand.push(STATE.deck.pop());
            this.syncState('RESET_ROUND'); 
            UI.showBubble(STATE.currTurn, "ÂèëÁâå‰∫Ü"); 
            this.processTurn();
        },
        processTurn: function() {
            UI.updateInfo(); let player = STATE.players[STATE.currTurn];
            // „ÄêÊ∏ÖÁêÜÊåá‰ª§ÂîØ‰∏ÄÂåñ„ÄëÔºöÂè™ÊúâÂÖ®ÂëòË∑≥Ëøá‰∏îÊúâ‰∫∫Ëµ¢‰∏ãËøô‰∏ÄËΩÆÊë∏ÁâåÊó∂Ê∏ÖÁêÜ
            if(STATE.passCount >= STATE.playerCount - 1 && STATE.lastPlay) {
                UI.showBubble(STATE.currTurn, "ËÄÅ‰π±ÔºÅÊ∏ÖÂú∫ÂÜçÊù•");
                UI.animSweep(()=>{ 
                    this.drawCard(STATE.currTurn); 
                    STATE.lastPlay=null; STATE.passCount=0; 
                    this.syncState(); this.continueTurn(player); 
                });
                return;
            }
            this.continueTurn(player);
        },
        continueTurn: function(player) {
            this.syncState();
            if(player.isCpu) { 
                document.getElementById('player-controls').classList.remove('active'); 
                setTimeout(()=>AI.move(player), 1500); 
            }
            else if(player.id === this.myPlayerIdx || (NET.mode === 'client' && player.peerId === NET.peer.id)) { 
                document.getElementById('player-controls').classList.add('active'); 
                this.checkHumanButtons(); 
            }
        },
        humanPlay: function() {
            let cards = STATE.selectedIndices.map(i=>STATE.players[this.myPlayerIdx].hand[i]);
            if(NET.mode==='client') { 
                NET.sendToHost({type:'ACTION',action:'play',cards:cards}); 
                STATE.selectedIndices=[]; 
                document.getElementById('player-controls').classList.remove('active'); 
            } else this.turnEnd('play', cards);
        },
        humanPass: function() {
            if(NET.mode==='client') { 
                NET.sendToHost({type:'ACTION',action:'pass'}); 
                document.getElementById('player-controls').classList.remove('active'); 
            } else this.turnEnd('pass');
        },
        nextRound: function() { this.resetRound(); },
        turnEnd: function(action, cards) {
            let pIdx = STATE.currTurn, player = STATE.players[pIdx];
            if(action === 'play') {
                let analysis = RULES.analyze(cards);
                STATE.lastPlay=analysis; STATE.lastPlay.ownerIdx=pIdx; STATE.lastPlay.cards=cards;
                // Êï∞ÊçÆÊõ¥Êñ∞ÔºöËÆ∞ÂΩïËØ•Áé©ÂÆ∂ÁöÑÂá∫ÁâåÔºå‰ª•‰æøÂêåÊ≠•
                player.lastCards = cards;
                STATE.passCount=0; if(analysis.type.includes('bomb')||analysis.type==='rocket') STATE.bombCount++;
                AUDIO.play((analysis.type.includes('bomb')||analysis.type==='rocket') ? 'bomb' : 'play');
                UI.showBubble(pIdx, CONFIG.SHANGHAI_WORDS.play[Math.floor(Math.random()*3)]);

                if(pIdx===this.myPlayerIdx) { STATE.selectedIndices.sort((a,b)=>b-a).forEach(i=>player.hand.splice(i,1)); STATE.selectedIndices=[]; }
                else { cards.forEach(c=>{ let idx=player.hand.findIndex(h=>h.val===c.val); if(idx>-1)player.hand.splice(idx,1); }); }
                
                UI.renderHand();
                UI.animThrow(pIdx, cards, () => { 
                    UI.renderPlayedCards(pIdx, cards); 
                    if(player.hand.length===0) setTimeout(()=>this.settle(pIdx),500); 
                    else this.nextTurn(); 
                });
            } else {
                STATE.passCount++; 
                AUDIO.play('pass'); 
                UI.showBubble(pIdx, CONFIG.SHANGHAI_WORDS.pass[Math.floor(Math.random()*3)]);
                this.nextTurn();
            }
        },
        nextTurn: function() { 
            STATE.currTurn=(STATE.currTurn+1)%STATE.playerCount; 
            if(NET.mode!=='client') this.processTurn(); 
        },
        drawCard: function(pIdx) { 
            if(STATE.deck.length>0) {
                STATE.players[pIdx].hand.push(STATE.deck.pop());
                UI.showBubble(pIdx, CONFIG.SHANGHAI_WORDS.draw[Math.floor(Math.random()*2)]);
            }
        },
        checkHumanButtons: function() {
            let play=document.getElementById('btn-play'), pass=document.getElementById('btn-pass'); 
            pass.disabled=(STATE.lastPlay===null);
            if(STATE.selectedIndices.length===0) { play.disabled=true; return; }
            let cards=STATE.selectedIndices.map(i=>STATE.players[this.myPlayerIdx].hand[i]), analysis=RULES.analyze(cards);
            play.disabled = !(analysis && RULES.canBeat(analysis, STATE.lastPlay));
        },
        settle: function(wIdx) {
            AUDIO.play('win'); 
            let list=document.getElementById('settle-list'); list.innerHTML=''; 
            let pot=0, mult=Math.pow(2,STATE.bombCount);
            STATE.players.forEach((p,i)=>{
                let isWin=(i===wIdx), cost=0;
                if(!isWin) { 
                    // [Update] Ââ©‰Ωô5Êàñ6Âº†ÁâåÊó∂ÔºåÂÄçÁéáÁøªÂÄç
                    let finalMult = mult * ([5, 6].includes(p.hand.length) ? 2 : 1);
                    cost=p.hand.length*finalMult; p.chips-=cost; pot+=cost; 
                    UI.showBubble(i, CONFIG.SHANGHAI_WORDS.lose[Math.floor(Math.random()*2)]);
                } else {
                    UI.showBubble(i, CONFIG.SHANGHAI_WORDS.win[Math.floor(Math.random()*3)]);
                }
                list.innerHTML+=`<div class="result-row" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px dashed #ccc;"><span>${p.name}</span><span>${p.hand.length}Âº†</span><span class="gain ${isWin?'plus':'minus'}" style="color:${isWin?'green':'red'}">${isWin?'Ê∏ÖÁàΩÔºÅ':'-'+cost}</span></div>`;
            });
            STATE.players[wIdx].chips+=pot; 
            document.getElementById('settlement-modal').classList.add('active');
            document.getElementById('next-round-btn').style.display = (NET.mode==='client') ? 'none' : 'inline-block';
            document.getElementById('wait-host-msg').style.display = (NET.mode==='client') ? 'block' : 'none';
            UI.updateInfo(); if(NET.mode==='host') this.syncState('SETTLE');
        },
        groupHand: function(h) {
            let a=h.map((c,i)=>({...c,oIdx:i,u:false})),b=[],p=[],s=[],r=[],j=a.filter(c=>c.isJoker);
            if(j.length===2){r.push({type:'rocket',val:99,count:2,idxs:j.map(c=>c.oIdx)});j.forEach(c=>c.u=true);}
            let cnt={}; a.forEach(c=>{if(!c.u)cnt[c.val]=(cnt[c.val]||0)+1});
            for(let v in cnt)if(cnt[v]>=3){let cs=a.filter(c=>!c.u&&c.val==v);b.push({type:'bomb',val:parseInt(v),count:cs.length,idxs:cs.map(c=>c.oIdx)});cs.forEach(c=>c.u=true);}
            cnt={}; a.forEach(c=>{if(!c.u)cnt[c.val]=(cnt[c.val]||0)+1});
            for(let v in cnt)if(cnt[v]===2){let cs=a.filter(c=>!c.u&&c.val==v);p.push({type:'pair',val:parseInt(v),count:2,idxs:cs.map(c=>c.oIdx)});cs.forEach(c=>c.u=true);}
            a.forEach(c=>{if(!c.u)s.push({type:'single',val:c.val,count:1,idxs:[c.oIdx]})});
            return {bombs:b,pairs:p,singles:s,rockets:r};
        },
        syncState: function(reason) {
            if(NET.mode==='host') NET.broadcast({type:'STATE',state:STATE,reason:reason});
            UI.renderLayout(); UI.renderHand(); UI.updateInfo(); 
            UI.showTurnNotify(STATE.currTurn);
            if(NET.mode !== 'offline') {
                let pin = NET.mode === 'host' ? NET.myPin : (STATE.roomPin || "...");
                document.getElementById('top-room-info').innerText = `[${pin}] ÂåÖÊàø ¬∑ ‰∏äÊµ∑Âπ≤Áû™Áúº`;
            } else {
                document.getElementById('top-room-info').innerText = `ÂçïÊú∫ÁªÉ‰π†Ê®°Âºè ¬∑ ‰∏äÊµ∑Âπ≤Áû™Áúº`;
            }
        },
        onNetworkData: function(data, senderConn) {
            if(NET.mode==='client') {
                if(data.type==='GAME_START') { 
                    STATE.players=data.players; STATE.playerCount=data.playerCount; STATE.roomPin = data.pin;
                    this.myPlayerIdx=STATE.players.findIndex(p=>p.peerId===NET.peer.id);
                    this.start(); 
                }
                else if(data.type==='STATE') {
                    STATE.players=data.state.players; STATE.deck=data.state.deck; STATE.currTurn=data.state.currTurn; STATE.lastPlay=data.state.lastPlay; STATE.passCount=data.state.passCount;
                    if(data.reason==='RESET_ROUND') {
                        document.getElementById('settlement-modal').classList.remove('active');
                    }
                    UI.updateInfo(); UI.renderLayout(); UI.renderHand(); UI.showTurnNotify(STATE.currTurn);
                    if(STATE.currTurn===this.myPlayerIdx) document.getElementById('player-controls').classList.add('active');
                }
            } else if(NET.mode==='host' && data.type==='ACTION') {
                let client=NET.clients.find(c=>c.conn===senderConn), pIdx=STATE.players.findIndex(p=>p.peerId===client.id);
                if(pIdx===STATE.currTurn) { if(data.action==='play')this.turnEnd('play',data.cards); else this.turnEnd('pass'); }
            }
        },
        quit: function() { location.reload(); }
    };

    /* ==========================================================================
       5. NETWORK ENGINE & AUDIO ENGINE
       ========================================================================== */
    const NET = {
        peer: null, mode: 'offline', hostConn: null, clients: [], myPin: null,
        initHost: function(cb) {
            this.mode = 'host'; this.clients = []; this.myPin = Math.floor(1000 + Math.random() * 9000).toString();
            if(this.peer) this.peer.destroy(); 
            this.peer = new Peer(CONFIG.APP_PREFIX + this.myPin, CONFIG.PEER_CONFIG);
            this.peer.on('open', () => cb(this.myPin));
            this.peer.on('connection', (conn) => {
                conn.on('open', () => conn.send({type:'WELCOME'}));
                conn.on('data', (data) => {
                    if(data.type === 'JOIN') { 
                        let existingPlayer = STATE.players.find(p => p.name === data.name);
                        if (existingPlayer) {
                            existingPlayer.peerId = conn.peer;
                            let client = this.clients.find(c => c.name === data.name);
                            if(client) client.conn = conn; else this.clients.push({conn, id: conn.peer, name: data.name});
                            conn.send({ type: 'GAME_START', players: STATE.players, playerCount: STATE.playerCount, pin: this.myPin });
                            conn.send({ type: 'STATE', state: STATE, reason: 'RECONNECT' });
                        } else if (STATE.players.length === 0) {
                            this.clients.push({ conn: conn, id: conn.peer, name: data.name }); 
                            UI.updateLobbyList(); 
                        }
                    } else APP.onNetworkData(data, conn);
                });
            });
        },
        joinRoom: function(pin, name, cbSuccess, cbErr) {
            this.mode = 'client'; if(this.peer) this.peer.destroy(); 
            this.peer = new Peer(CONFIG.PEER_CONFIG);
            this.peer.on('open', () => {
                this.hostConn = this.peer.connect(CONFIG.APP_PREFIX + pin, { reliable: true });
                this.hostConn.on('open', () => { this.hostConn.send({ type: 'JOIN', name: name }); cbSuccess(); });
                this.hostConn.on('data', (data) => APP.onNetworkData(data));
                this.hostConn.on('close', () => location.reload());
            });
            this.peer.on('error', (err) => cbErr(err));
        },
        broadcast: function(data) { if(this.mode === 'host') this.clients.forEach(c => { if(c.conn && c.conn.open) c.conn.send(data); }); },
        sendToHost: function(data) { if(this.mode === 'client' && this.hostConn && this.hostConn.open) this.hostConn.send(data); }
    };

    const AUDIO = {
        ctx: null, init: function() { window.AudioContext = window.AudioContext||window.webkitAudioContext; this.ctx = new AudioContext(); },
        play: function(type) { if(this.Recorder.playRandom(type)) return; this.playSynth(type); },
        playSynth: function(type) {
            if(!this.ctx) return; const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
            if(type==='play') { o.frequency.setValueAtTime(600,t); o.frequency.exponentialRampToValueAtTime(100,t+0.1); g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1); }
            else if(type==='win') { [523,659,783].forEach((f,i)=>{let x=this.ctx.createOscillator(),y=this.ctx.createGain();x.connect(y);y.connect(this.ctx.destination);x.frequency.value=f;y.gain.setValueAtTime(0.1,t+i*0.1);y.gain.linearRampToValueAtTime(0,t+i*0.1+0.5);x.start(t+i*0.1);x.stop(t+i*0.1+0.5);}); }
            else { o.type='square'; o.frequency.value=150; g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2); }
        },
        Recorder: {
            sounds: {'play':[],'pass':[],'bomb':[],'win':[],'alert':[]}, labels: {'play':'Play','pass':'Pass','bomb':'Bomb','win':'Win','alert':'Error'},
            openUI: function() { document.getElementById('cassette-modal').classList.add('active'); this.renderUI(); },
            closeUI: function() { document.getElementById('cassette-modal').classList.remove('active'); },
            renderUI: function() { let c=document.getElementById('tape-list'); c.innerHTML='<div style="text-align:center; font-size:20px; color:var(--vintage-gold); margin-bottom:20px; border-bottom:1px solid #555;"> Tape Recorder</div>'; for(let k in this.sounds) c.innerHTML+=`<div style="display:flex; align-items:center; justify-content:space-between; background:#3e2723; padding:10px; margin-bottom:8px; border-radius:4px; border:1px solid #5d4037;"><div class="tape-label">${this.labels[k]}</div><div style="display:flex; gap:10px;"><div id="takes-${k}" style="display:flex; gap:5px;"></div><button style="background:#c62828; color:white; border:none; padding:5px 10px; border-radius:50%; font-size:12px; cursor:pointer; width:30px; height:30px;" onmousedown="AUDIO.Recorder.start('${k}',this)" onmouseup="AUDIO.Recorder.stop(this)">‚óè</button></div></div>`; this.refreshTakes(); },
            refreshTakes: function() { for(let k in this.sounds) { let d=document.getElementById(`takes-${k}`); if(d) { d.innerHTML=''; this.sounds[k].forEach((_,i)=>d.innerHTML+=`<div style="background:#444; padding:2px 6px; border-radius:4px; font-size:10px; display:flex; gap:4px; border:1px solid #666;">T${i+1}<span style="cursor:pointer;color:#81c784" onclick="AUDIO.Recorder.prev('${k}',${i})">‚ñ∂</span><span style="cursor:pointer;color:#e57373" onclick="AUDIO.Recorder.del('${k}',${i})">√ó</span></div>`); } } },
            start: function(k,b) { navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{this.m=new MediaRecorder(s);this.c=[];this.m.ondataavailable=e=>this.c.push(e.data);this.m.onstop=()=>{this.sounds[k].push(URL.createObjectURL(new Blob(this.c)));this.refreshTakes();};this.m.start();b.style.boxShadow="0 0 10px red";}).catch(()=>{alert("È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÔºÅ");}); },
            stop: function(b) { if(this.m&&this.m.state==='recording'){this.m.stop();b.style.boxShadow="none";} },
            del: function(k,i) { this.sounds[k].splice(i,1); this.refreshTakes(); }, prev: function(k,i) { new Audio(this.sounds[k][i]).play(); },
            playRandom: function(k) { if(this.sounds[k].length) { new Audio(this.sounds[k][Math.floor(Math.random()*this.sounds[k].length)]).play(); return true; } return false; }
        }
    };
</script>
</body>
</html>